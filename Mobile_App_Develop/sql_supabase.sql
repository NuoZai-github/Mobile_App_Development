-- Supabase Postgres SQL for UTS Bus Tracker
-- Run this file in Supabase's SQL editor (PostgreSQL environment)

-- Enable UUID generation for notifications (available by default in Supabase)
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ======================================
-- User Profiles (extends Supabase auth.users)
-- ======================================
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    first_name TEXT NOT NULL,
    last_name TEXT NOT NULL,
    student_id TEXT UNIQUE NOT NULL,
    avatar_url TEXT DEFAULT 'https://via.placeholder.com/150',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    last_login_at TIMESTAMPTZ,
    is_active BOOLEAN DEFAULT TRUE,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can view own profile" ON public.profiles;
CREATE POLICY "Users can view own profile" ON public.profiles
    FOR SELECT USING (auth.uid() = id);

DROP POLICY IF EXISTS "Users can update own profile" ON public.profiles;
CREATE POLICY "Users can update own profile" ON public.profiles
    FOR UPDATE USING (auth.uid() = id);

DROP POLICY IF EXISTS "Users can insert own profile" ON public.profiles;
CREATE POLICY "Users can insert own profile" ON public.profiles
    FOR INSERT WITH CHECK (auth.uid() = id);

CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS update_profiles_updated_at ON public.profiles;
CREATE TRIGGER update_profiles_updated_at
    BEFORE UPDATE ON public.profiles
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_updated_at();

CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.profiles (id, email, first_name, last_name, student_id)
    VALUES (
        NEW.id,
        NEW.email,
        COALESCE(NEW.raw_user_meta_data->>'first_name', ''),
        COALESCE(NEW.raw_user_meta_data->>'last_name', ''),
        COALESCE(NEW.raw_user_meta_data->>'student_id', '')
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_new_user();

CREATE OR REPLACE FUNCTION public.update_last_login()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE public.profiles 
    SET last_login_at = NOW()
    WHERE id = NEW.id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_auth_user_login ON auth.users;
CREATE TRIGGER on_auth_user_login
    AFTER UPDATE OF last_sign_in_at ON auth.users
    FOR EACH ROW
    WHEN (OLD.last_sign_in_at IS DISTINCT FROM NEW.last_sign_in_at)
    EXECUTE FUNCTION public.update_last_login();

CREATE INDEX IF NOT EXISTS idx_profiles_email ON public.profiles(email);
CREATE INDEX IF NOT EXISTS idx_profiles_student_id ON public.profiles(student_id);
CREATE INDEX IF NOT EXISTS idx_profiles_created_at ON public.profiles(created_at);

-- ======================================
-- UTS Bus Tracker domain schema (PostgreSQL)
-- ======================================

-- Routes
CREATE TABLE IF NOT EXISTS public.routes (
  id                          INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name                        TEXT    NOT NULL UNIQUE,
  description                 TEXT    NOT NULL DEFAULT '',
  color                       TEXT    NOT NULL DEFAULT '#2196F3',
  start_time                  TIME    NOT NULL DEFAULT '06:00:00',
  end_time                    TIME    NOT NULL DEFAULT '22:00:00',
  frequency_minutes           INTEGER NOT NULL DEFAULT 15,
  is_active                   BOOLEAN NOT NULL DEFAULT TRUE,
  total_distance              DOUBLE PRECISION NOT NULL DEFAULT 0.0,
  estimated_duration_minutes  INTEGER NOT NULL DEFAULT 30
);

-- Bus stops
CREATE TABLE IF NOT EXISTS public.bus_stops (
  id           INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name         TEXT    NOT NULL,
  latitude     DOUBLE PRECISION NOT NULL,
  longitude    DOUBLE PRECISION NOT NULL,
  is_active    BOOLEAN NOT NULL DEFAULT TRUE,
  description  TEXT    NOT NULL DEFAULT ''
);

-- Route-stop mapping
CREATE TABLE IF NOT EXISTS public.route_stops (
  route_id   INTEGER NOT NULL,
  stop_id    INTEGER NOT NULL,
  ord        INTEGER NOT NULL,
  PRIMARY KEY (route_id, stop_id),
  FOREIGN KEY (route_id) REFERENCES public.routes(id) ON DELETE CASCADE ON UPDATE CASCADE,
  FOREIGN KEY (stop_id)  REFERENCES public.bus_stops(id) ON DELETE CASCADE ON UPDATE CASCADE
);

-- Stop amenities
CREATE TABLE IF NOT EXISTS public.bus_stop_amenities (
  stop_id   INTEGER NOT NULL,
  amenity   TEXT    NOT NULL,
  PRIMARY KEY (stop_id, amenity),
  FOREIGN KEY (stop_id) REFERENCES public.bus_stops(id) ON DELETE CASCADE ON UPDATE CASCADE
);

-- Buses
CREATE TABLE IF NOT EXISTS public.buses (
  id                 INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  bus_number         TEXT    NOT NULL,
  driver_name        TEXT    NOT NULL DEFAULT '',
  route_id           INTEGER,
  latitude           DOUBLE PRECISION NOT NULL DEFAULT 0.0,
  longitude          DOUBLE PRECISION NOT NULL DEFAULT 0.0,
  status             INTEGER NOT NULL DEFAULT 0,
  capacity           INTEGER NOT NULL DEFAULT 50,
  current_passengers INTEGER NOT NULL DEFAULT 0,
  last_updated       TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  speed              DOUBLE PRECISION NOT NULL DEFAULT 0.0,
  direction          TEXT    NOT NULL DEFAULT '',
  estimated_arrival  TIMESTAMPTZ,
  next_stop          TEXT    NOT NULL DEFAULT '',
  is_active          BOOLEAN NOT NULL DEFAULT TRUE,
  FOREIGN KEY (route_id) REFERENCES public.routes(id) ON DELETE SET NULL ON UPDATE CASCADE
);

-- Notifications
CREATE TABLE IF NOT EXISTS public.notifications (
  id            UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  title         TEXT    NOT NULL,
  message       TEXT    NOT NULL,
  type          INTEGER NOT NULL DEFAULT 0,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  is_read       BOOLEAN NOT NULL DEFAULT FALSE,
  bus_id        INTEGER,
  route_id      INTEGER,
  icon_name     TEXT    NOT NULL DEFAULT 'info_circle.png',
  action_url    TEXT    NOT NULL DEFAULT '',
  scheduled_for TIMESTAMPTZ,
  is_active     BOOLEAN NOT NULL DEFAULT TRUE,
  FOREIGN KEY (bus_id)   REFERENCES public.buses(id)   ON DELETE SET NULL ON UPDATE CASCADE,
  FOREIGN KEY (route_id) REFERENCES public.routes(id) ON DELETE SET NULL ON UPDATE CASCADE
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_buses_route_id              ON public.buses(route_id);
CREATE INDEX IF NOT EXISTS idx_notifications_bus_id        ON public.notifications(bus_id);
CREATE INDEX IF NOT EXISTS idx_notifications_route_id      ON public.notifications(route_id);
CREATE INDEX IF NOT EXISTS idx_route_stops_route_ord       ON public.route_stops(route_id, ord);
CREATE INDEX IF NOT EXISTS idx_bus_stops_name              ON public.bus_stops(name);

-- Views
CREATE OR REPLACE VIEW public.v_active_buses AS
SELECT b.id,
       b.bus_number,
       r.name AS route_name,
       b.latitude,
       b.longitude,
       b.status,
       b.next_stop,
       b.estimated_arrival,
       b.current_passengers,
       b.capacity
FROM public.buses b
LEFT JOIN public.routes r ON r.id = b.route_id
WHERE b.is_active = TRUE AND (r.is_active = TRUE OR r.id IS NULL);

CREATE OR REPLACE VIEW public.v_route_stops AS
SELECT r.id   AS route_id,
       r.name AS route_name,
       rs.ord,
       s.id   AS stop_id,
       s.name AS stop_name,
       s.latitude,
       s.longitude
FROM public.route_stops rs
JOIN public.routes r     ON r.id = rs.route_id
JOIN public.bus_stops s  ON s.id = rs.stop_id
ORDER BY r.id, rs.ord;

-- ======================================
-- Sample data (optional)
-- ======================================
BEGIN;

-- Routes
INSERT INTO public.routes (id, name, description, color, start_time, end_time, frequency_minutes, is_active, total_distance, estimated_duration_minutes)
VALUES
  (1, 'Campus Loop', 'Main campus circular route', '#2196F3', '06:00:00', '22:00:00', 15, TRUE, 8.5, 25),
  (2, 'City Express', 'Direct route to city center', '#FF5722', '07:00:00', '19:00:00', 20, TRUE, 12.3, 35)
ON CONFLICT (name) DO NOTHING;

-- Bus stops
INSERT INTO public.bus_stops (id, name, latitude, longitude, is_active, description) VALUES
  (1, 'Central Station',        -33.8688, 151.2093, TRUE, ''),
  (2, 'Library',                -33.8678, 151.2103, TRUE, ''),
  (3, 'Engineering Building',   -33.8668, 151.2113, TRUE, ''),
  (4, 'Student Center',         -33.8658, 151.2123, TRUE, ''),
  (5, 'Sports Complex',         -33.8648, 151.2133, TRUE, ''),
  (6, 'UTS Main Gate',          -33.8838, 151.2003, TRUE, ''),
  (7, 'Town Hall',              -33.8728, 151.2063, TRUE, ''),
  (8, 'Circular Quay',          -33.8618, 151.2113, TRUE, '')
ON CONFLICT (id) DO NOTHING;

-- Route-stop mapping
INSERT INTO public.route_stops (route_id, stop_id, ord) VALUES
  (1, 1, 1), (1, 2, 2), (1, 3, 3), (1, 4, 4), (1, 5, 5),
  (2, 6, 1), (2, 7, 2), (2, 8, 3)
ON CONFLICT DO NOTHING;

-- Amenities
INSERT INTO public.bus_stop_amenities (stop_id, amenity) VALUES
  (2, 'Shelter'), (2, 'Seating'), (2, 'WiFi'),
  (4, 'Toilets'), (4, 'Seating')
ON CONFLICT DO NOTHING;

-- Buses (BusStatus: Stopped=0, Moving=1, AtStop=2, OutOfService=3, Maintenance=4, InService=5, Delayed=6)
INSERT INTO public.buses (id, bus_number, driver_name, route_id, latitude, longitude, status, capacity, current_passengers, speed, direction, next_stop, estimated_arrival, is_active)
VALUES
  (1, 'UTS001', 'Michael Chen', 1, -33.8688, 151.2093, 1, 50, 23, 25.5, 'Clockwise', 'Library',         NOW() + INTERVAL '3 minutes', TRUE),
  (2, 'UTS002', 'Sarah Johnson', 1, -33.8658, 151.2123, 2, 50, 31, 0.0,  'Clockwise', 'Sports Complex', NOW() + INTERVAL '1 minutes', TRUE),
  (3, 'UTS003', 'David Wilson',  2, -33.8838, 151.2003, 1, 60, 18, 35.0, 'To City',   'Town Hall',      NOW() + INTERVAL '8 minutes', TRUE)
ON CONFLICT (id) DO NOTHING;

-- Notifications (NotificationType examples)
INSERT INTO public.notifications (title, message, type, created_at, is_read, bus_id, route_id, icon_name, action_url, scheduled_for, is_active)
VALUES
  ('Welcome to UTS Bus Tracker!', 'Track your campus buses in real-time and never miss your ride.', 0, NOW() - INTERVAL '2 hours', FALSE, NULL, NULL, 'welcome.png', '', NULL, TRUE),
  ('Bus UTS001 Arriving Soon',   'Your bus will arrive at Library stop in 3 minutes.',              3, NOW() - INTERVAL '15 minutes', TRUE, 1, NULL, 'bus_arrival.png', '', NULL, TRUE),
  ('Route Update',               'Campus Loop route has been updated with new timing.',             4, NOW() - INTERVAL '1 hours',   FALSE, NULL, NULL, 'route_update.png', '', NULL, TRUE)
ON CONFLICT DO NOTHING;

COMMIT;