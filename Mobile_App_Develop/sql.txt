-- Supabase SQL 代码用于用户注册功能
-- 这些SQL语句需要在Supabase SQL编辑器中执行

-- 1. 创建用户资料表 (profiles)
-- 注意：Supabase已经有内置的auth.users表用于身份验证
-- 我们创建一个profiles表来存储额外的用户信息

CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    first_name TEXT NOT NULL,
    last_name TEXT NOT NULL,
    student_id TEXT UNIQUE NOT NULL,
    avatar_url TEXT DEFAULT 'https://via.placeholder.com/150',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login_at TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT TRUE,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. 启用行级安全 (Row Level Security)
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- 3. 创建RLS策略 - 用户只能查看和更新自己的资料
CREATE POLICY "Users can view own profile" ON public.profiles
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON public.profiles
    FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile" ON public.profiles
    FOR INSERT WITH CHECK (auth.uid() = id);

-- 4. 创建触发器函数来自动更新updated_at字段
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 5. 创建触发器
CREATE TRIGGER update_profiles_updated_at
    BEFORE UPDATE ON public.profiles
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_updated_at();

-- 6. 创建函数来自动创建用户资料当新用户注册时
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.profiles (id, email, first_name, last_name, student_id)
    VALUES (
        NEW.id,
        NEW.email,
        COALESCE(NEW.raw_user_meta_data->>'first_name', ''),
        COALESCE(NEW.raw_user_meta_data->>'last_name', ''),
        COALESCE(NEW.raw_user_meta_data->>'student_id', '')
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 7. 创建触发器来自动处理新用户注册
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_new_user();

-- 8. 创建函数来更新最后登录时间
CREATE OR REPLACE FUNCTION public.update_last_login()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE public.profiles 
    SET last_login_at = NOW()
    WHERE id = NEW.id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 9. 创建触发器来自动更新最后登录时间
CREATE TRIGGER on_auth_user_login
    AFTER UPDATE OF last_sign_in_at ON auth.users
    FOR EACH ROW
    WHEN (OLD.last_sign_in_at IS DISTINCT FROM NEW.last_sign_in_at)
    EXECUTE FUNCTION public.update_last_login();

-- 10. 创建索引以提高查询性能
CREATE INDEX IF NOT EXISTS idx_profiles_email ON public.profiles(email);
CREATE INDEX IF NOT EXISTS idx_profiles_student_id ON public.profiles(student_id);
CREATE INDEX IF NOT EXISTS idx_profiles_created_at ON public.profiles(created_at);

-- 11. 插入示例数据 (可选 - 用于测试)
-- INSERT INTO public.profiles (id, email, first_name, last_name, student_id)
-- VALUES (
--     gen_random_uuid(),
--     'test@example.com',
--     'Test',
--     'User',
--     '12345678'
-- );

-- 使用说明：
-- 1. 在Supabase Dashboard中，进入SQL编辑器
-- 2. 复制并粘贴上述SQL代码
-- 3. 点击"Run"执行SQL
-- 4. 确认所有表和函数都已成功创建
-- 5. 在应用中注册新用户时，用户信息会自动存储到profiles表中

-- 注意事项：
-- - auth.users表由Supabase自动管理，存储身份验证信息
-- - profiles表存储额外的用户资料信息
-- - 使用UUID作为主键，与auth.users表关联
-- - 启用了行级安全，确保用户只能访问自己的数据
-- - 自动触发器处理用户注册和登录时间更新